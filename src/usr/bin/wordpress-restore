#!/bin/bash

WP_CONTAINER="charlotte-website-wordpress"
DB_CONTAINER="charlotte-website-mariadb"

function restore() {
  # Obtain last backup
  file=$(gsutil ls -l gs://charlotte-website-backup/ | sort -k 3 | head -n1 | tr -s " " | cut -d " " -f 4)
  gsutil cp $file backup-restore.tar.gz

  # Unzip backup
  tar xvf backup-restore.tar.gz backup-restore

  # Restore volume from backup
  docker run --rm --volumes-from $WP_CONTAINER -v $(pwd)/backup-restore:/backup ubuntu bash -c "cd /var/www/html && tar xvf /backup/wp_backup.tar --strip 1"

  # Restore DB from dump
  cat $(pwd)/backup-restore/db_backup.sql | docker exec -i $DB_CONTAINER /usr/bin/mysql -u root --password=$pw $db

  # Restart the containers
  docker-compose restart

  # Clean the restored backups
  rm -rf backup-restore
  rm -f backup-restore.tar.gz
}

function usage() {
  echo -e "\nError: Missing arguments\n"
  echo "Usage: $0 [-d --database] [-p --password]"
  echo "  -d, --database    The name of the database to restore"
  echo "  -p, --password    The password to the specified database"
  exit 1
}

while [[ "$#" -gt 0 ]]; do
    case $1 in
        -d|--database) db="$2"; shift ;;
        -p|--password) pw="$2"; shift ;;
        *) echo "Unknown parameter passed: $1"; exit 1 ;;
    esac
    shift
done

if [ -z "$db" ]; then usage; fi;
if [ -z "$pw" ]; then usage; fi;

restore
