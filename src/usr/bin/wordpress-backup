#!/bin/bash

LOG_FILE="/var/log/wordpress/backup.log"
WP_CONTAINER="charlotte-website-wordpress"
DB_CONTAINER="charlotte-website-mariadb"

function backup() {
  echo "[$(date +%Y-%m-%d:%T)] Starting backup"

  # Generate backups from the volume
  docker run --rm --volumes-from $WP_CONTAINER -v $(pwd)/backup:/backup ubuntu tar cf /backup/wp_backup.tar /var/www/html

  # Dump the DB
  docker exec $DB_CONTAINER /usr/bin/mysqldump -u root --password=$pw $db > $(pwd)/backup/db_backup.sql

  # gzip the backups
  tar czf backup.tar.gz backup

  # Ship the backups to external storage
  timestamp=$(date +%Y-%m-%d)
  echo "[$(date +%Y-%m-%d:%T)] wordpress-backup-${timestamp}.tar.gz"
  gsutil cp backup.tar.gz gs://charlotte-website-backup/wordpress-backup-${timestamp}.tar.gz

  # Clean the backups
  rm -rf backup
  rm -f backup.tar.gz

  echo "[$(date +%Y-%m-%d:%T)] Backup complete"
}

function usage() {
  echo -e "\nError: Missing arguments\n"
  echo "Usage: $0 [-d --database] [-p --password]"
  echo "  -d, --database    The name of the database to restore"
  echo "  -p, --password    The password to the specified database"
  exit 1
}

while [[ "$#" -gt 0 ]]; do
    case $1 in
        -d|--database) db="$2"; shift ;;
        -p|--password) pw="$2"; shift ;;
        *) echo "Unknown parameter passed: $1"; exit 1 ;;
    esac
    shift
done

if [ -z "$db" ]; then usage; fi;
if [ -z "$pw" ]; then usage; fi;

backup >> "${LOG_FILE}"
